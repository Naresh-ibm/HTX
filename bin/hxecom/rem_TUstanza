#!/bin/bash
# @(#)16        1.2     src/htx/usr/lpp/htx/bin/hxecom/rem_TUstanza, exer_com, htxgrsle9 4/13/05 06:35:00

rm -f /tmp/intf_map.txt  >/dev/null 2>&1

cp  /usr/lpp/htx/mdt/mdt /tmp/mdt.intial

mkintfmap  eth #executable which forms the file /tmp/intf_map.txt with
			   # eth and pci mapping and the 1 parameter is PCI class type
			   # info and only supported class is eth
 
ker_ver=$(uname -r | grep "2\.4\.") #kernel version variable

for intf in $(awk '($1~/eth/) && ($1~/:/) { split($1,names,":"); print names[1]; }' /usr/lpp/htx/mdt/mdt)
do

for pci_id in $( awk 'BEGIN {} {if($1==interf) print $3}' interf=$intf /tmp/intf_map.txt);
do

	#echo "Interface=" $intf ", PCI Identification =" $pci_id

	first=${pci_id%:*:*}
	second=${pci_id#*:*:}

	remd_irq=${second%:*}
	if [ $ker_ver ]
	then
		second=$remd_irq
	fi

	device=${first#*:}
	bus=${first%:*}

	chrcount=${#device}
	if [ "$chrcount" -lt "2" ];
	then 
		str=0$device:$second
	else 
		str=$device:$second
	fi
	
	if [ $ker_ver ]
	then
		str=$bus:$device:$second
	fi

	#Defect 499866 bus single digit making it '0x' instead of 'x'
	chrcount=${#bus}
	if [ "$chrcount" -eq "3" ];
	then 
		str=$bus:$str
	else 
		if [ "$chrcount" -eq "2" ];
		then
			str=0$bus:$str
		else
		        str=00$bus:$str
		fi
	fi
	
	#echo "String to find in devlist.txt is " $str

	for devic in $(awk '{if($3==par) print $1":" }' par=$str /tmp/devlist.txt);
	do
		echo "This device is removed from the mdt file as hxecom is running on it :" $devic
		awk 'BEGIN{t=0} {if($1==parm){t=1;next;} }  (t==1) { if( $1 !~ /:/ ) next; else t=0} (t==0 ) { print $0 }'  parm=$devic /usr/lpp/htx/mdt/mdt >  /tmp/new_mdt

		cp /tmp/new_mdt /usr/lpp/htx/mdt/mdt

	done #for loop for device ends

done

done #for loop for intf ends
 




